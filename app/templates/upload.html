<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Téléverser — Analyse de conformité CNAPS</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; }
    @media (max-width:1000px){ .grid{ grid-template-columns:1fr; } }
    .dz {
      border:1px dashed var(--border); border-radius:14px; padding:14px; background:var(--card);
      min-height:110px; display:flex; flex-direction:column; gap:10px; transition: border-color .15s, background-color .15s;
    }
    .dz:hover { background: rgba(255,255,255,0.02); }
    .dz.active { border-color: var(--accent); background: rgba(79,134,255,0.08); }
    .dz.ok { border-color:#25a244; background: rgba(37,162,68,0.08); }
    .dz h3 { margin:0; font-size:16px; }
    .dz .hint { color:var(--muted); font-size:12px; margin:0; }
    .files { display:flex; flex-wrap:wrap; gap:8px; }
    .chip { border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; background:transparent; }
    .check { margin-left:auto; font-size:22px; display:none; }
    .dz.ok .check { display:inline; color:#25a244; }
    .toolbar { display:flex; gap:10px; margin:16px 0; flex-wrap:wrap; align-items:center; }
    .btn { display:inline-block; padding:10px 16px; border-radius:999px; border:1px solid var(--border); text-decoration:none; font-weight:600; }
    .btn.primary { background: var(--fg); color: var(--bg); border-color: transparent; }
    .ok-banner { display:none; margin-top:10px; color:#25a244; font-weight:600; }
    .error { color:#ff6b6b; font-size:14px; }
    .two { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:800px){ .two{ grid-template-columns:1fr; } }
  </style>
</head>
<body class="wrap">
  <header class="wrap" style="padding-left:0;padding-right:0;">
    <h1>Analyse de conformité CNAPS — Téléversement</h1>
    <nav><a href="/">Accueil</a> · <a href="/docs">Docs</a></nav>
  </header>

  <main>
    <div class="two">
      <section>
        <div class="toolbar">
          <input id="company" type="text" placeholder="Nom de l'entreprise *" required style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--fg);" />
          <input id="website" type="text" placeholder="Site internet (optionnel)" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--fg);" />
        </div>

        <div class="grid" id="zones">
          <!-- Chaque zone => data-field = nom du champ côté API -->
          <div class="dz" data-field="autorisation_exercer"><h3>Autorisation d’exercer <span class="check">✔</span></h3><p class="hint">PDF/DOCX</p><div class="files"></div></div>
          <div class="dz" data-field="agrement_dirigeant"><h3>Agrément dirigeant <span class="check">✔</span></h3><p class="hint">PDF/DOCX</p><div class="files"></div></div>
          <div class="dz" data-field="attestation_assurance_pro"><h3>Attestation d’assurance professionnelle <span class="check">✔</span></h3><p class="hint">PDF</p><div class="files"></div></div>
          <div class="dz" data-field="extrait_kbis"><h3>Extrait Kbis <span class="check">✔</span></h3><p class="hint">PDF</p><div class="files"></div></div>
          <div class="dz" data-field="statuts_entreprise"><h3>Statuts de l’entreprise à jour <span class="check">✔</span></h3><p class="hint">PDF</p><div class="files"></div></div>
          <div class="dz" data-field="dsn"><h3>Déclarations sociales nominatives (DSN) <span class="check">✔</span></h3><p class="hint">ZIP/PDF</p><div class="files"></div></div>
          <div class="dz" data-field="attestation_vigilance_urssaf"><h3>Attestation de vigilance URSSAF <span class="check">✔</span></h3><p class="hint">PDF</p><div class="files"></div></div>
          <div class="dz" data-field="releves_bancaires"><h3>Relevés de comptes (6 mois) <span class="check">✔</span></h3><p class="hint">PDF/CSV</p><div class="files"></div></div>
          <div class="dz" data-field="liasse_fiscale"><h3>Dernière liasse fiscale <span class="check">✔</span></h3><p class="hint">PDF/ZIP</p><div class="files"></div></div>
          <div class="dz" data-field="grand_livre"><h3>Grand livre de comptes <span class="check">✔</span></h3><p class="hint">PDF/CSV/XLSX</p><div class="files"></div></div>
          <div class="dz" data-field="plannings_agents"><h3>Plannings des agents (6 mois) <span class="check">✔</span></h3><p class="hint">PDF/XLSX</p><div class="files"></div></div>
          <div class="dz" data-field="bulletins_paie_agents"><h3>Bulletins de paie agents (6 mois) <span class="check">✔</span></h3><p class="hint">ZIP/PDF</p><div class="files"></div></div>
          <div class="dz" data-field="factures"><h3>Factures (6 mois) <span class="check">✔</span></h3><p class="hint">PDF/ZIP</p><div class="files"></div></div>
          <div class="dz" data-field="liste_sous_traitants"><h3>Liste des sous-traitants <span class="check">✔</span></h3><p class="hint">PDF/XLSX</p><div class="files"></div></div>
          <div class="dz" data-field="attestations_vigilance_sous_traitants"><h3>Attestations vigilance (sous-traitants) <span class="check">✔</span></h3><p class="hint">PDF/ZIP</p><div class="files"></div></div>
          <div class="dz" data-field="contrats_sous_traitance"><h3>Contrats de sous-traitance <span class="check">✔</span></h3><p class="hint">PDF/ZIP</p><div class="files"></div></div>
          <div class="dz" data-field="modele_carte_professionnelle"><h3>Modèle carte professionnelle <span class="check">✔</span></h3><p class="hint">PDF/JPG/PNG</p><div class="files"></div></div>
          <div class="dz" data-field="registre_personnel"><h3>Registre unique du personnel <span class="check">✔</span></h3><p class="hint">PDF/XLSX</p><div class="files"></div></div>
          <div class="dz" data-field="registre_controles_internes"><h3>Registre des contrôles internes <span class="check">✔</span></h3><p class="hint">PDF</p><div class="files"></div></div>
          <div class="dz" data-field="justificatifs_dpae"><h3>Justificatifs DPAE <span class="check">✔</span></h3><p class="hint">PDF/ZIP</p><div class="files"></div></div>
          <div class="dz" data-field="factures_sous_traitants"><h3>Factures des sous-traitants <span class="check">✔</span></h3><p class="hint">PDF/ZIP</p><div class="files"></div></div>
        </div>

        <div class="toolbar">
          <button id="send" class="btn primary">Téléverser</button>
          <span id="ok" class="ok-banner">Téléversement réussi ✅</span>
          <span id="err" class="error"></span>
        </div>
      </section>

      <!-- Colonne de droite : nomenclature rappel -->
      <aside>
        <h2>Nomenclature des pièces</h2>
        <ul>
          <li>Autorisation d’exercer</li>
          <li>Agrément dirigeant</li>
          <li>Attestation d’assurance professionnelle</li>
          <li>Extrait Kbis</li>
          <li>Statuts de l’entreprise à jour</li>
          <li>Déclarations sociales nominatives (DSN)</li>
          <li>Attestation de vigilance URSSAF à jour</li>
          <li>Relevés de comptes professionnels (6 mois)</li>
          <li>Dernière liasse fiscale</li>
          <li>Grand livre de comptes</li>
          <li>Plannings des agents (6 mois)</li>
          <li>Bulletins de paie des agents (6 mois)</li>
          <li>Factures (6 mois)</li>
          <li>Liste des sous-traitants</li>
          <li>Attestations de vigilance URSSAF (sous-traitants)</li>
          <li>Contrats de sous-traitance</li>
          <li>Modèle carte professionnelle (entreprise)</li>
          <li>Registre unique du personnel</li>
          <li>Registre des contrôles internes</li>
          <li>Justificatifs DPAE</li>
          <li>Factures des sous-traitants</li>
        </ul>
        <p class="hint">Taille max : {{ max_mb }} Mo par fichier.</p>
      </aside>
    </div>
  </main>

  <script>
    const ZONES = document.querySelectorAll('.dz');
    const state = new Map(); // field -> File[]
    const err = document.getElementById('err');
    const ok = document.getElementById('ok');
    const sendBtn = document.getElementById('send');

    function addFiles(field, files) {
      const list = state.get(field) || [];
      for (const f of files) list.push(f);
      state.set(field, list);
      renderChips(field);
    }

    function renderChips(field) {
      const zone = document.querySelector(`.dz[data-field="${field}"]`);
      const box = zone.querySelector('.files');
      box.innerHTML = '';
      const list = state.get(field) || [];
      list.forEach(f => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.textContent = f.name;
        box.appendChild(span);
      });
    }

    ZONES.forEach(zone => {
      const field = zone.dataset.field;
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('active'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('active'));
      zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('active');
        addFiles(field, e.dataTransfer.files);
      });
      // clic pour ouvrir un sélecteur
      zone.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file'; input.multiple = true;
        input.onchange = ev => addFiles(field, ev.target.files);
        input.click();
      });
    });

    sendBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      err.textContent = ''; ok.style.display = 'none';

      const company = document.getElementById('company').value.trim();
      const website = document.getElementById('website').value.trim();
      if (!company) { err.textContent = "Le nom de l'entreprise est requis."; return; }

      const fd = new FormData();
      fd.append('company_name', company);
      if (website) fd.append('website_url', website);

      // ajouter les fichiers par champ
      state.forEach((files, field) => {
        files.forEach(f => fd.append(field, f, f.name));
      });

      try {
        const res = await fetch('/upload', { method: 'POST', body: fd });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || ('HTTP ' + res.status));
        }
        const data = await res.json();

        // marque verte sur chaque zone ayant des fichiers
        ZONES.forEach(z => {
          const field = z.dataset.field;
          if ((state.get(field) || []).length) {
            z.classList.add('ok');
          }
        });

        ok.style.display = 'inline';
        // Option: vider l'état après succès
        // state.clear();
        // document.querySelectorAll('.files').forEach(f => f.innerHTML = '');
      } catch (e2) {
        err.textContent = "Erreur lors du téléversement : " + (e2.message || e2);
      }
    });
  </script>
</body>
</html>
