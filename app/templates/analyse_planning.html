<!doctype html><meta charset="utf-8">
<title>Analyse • CSI</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="data:,">
<style>
  :root{--bg:#0b1020;--card:#111833;--text:#e6e9f2;--muted:#9aa3b2;--accent:#6aa1ff}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1630);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1000px;margin:48px auto;padding:0 20px}.card{background:var(--card);border:1px solid #1b254a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:24px}
  h1{margin:0 0 12px;font-size:26px}.muted{color:var(--muted)} .row{display:flex;gap:12px;margin:10px 0 20px}
  button{cursor:pointer;border:1px solid #2a3a75;background:#1a2a6a;color:#eaf1ff;padding:10px 14px;border-radius:10px}
  table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid #223166;padding:8px;text-align:left} th{background:#182455}
  .spinner{display:inline-block;width:16px;height:16px;border:2px solid #6aa1ff;border-right-color:transparent;border-radius:50%;animation:spin .8s linear infinite;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
<div class="wrap"><div class="card">
  <h1>Analyse des plannings</h1>
  <p class="muted" id="src"></p>
  <div id="status"><span class="spinner"></span> Analyse en cours…</div>
  <div id="error" style="color:#ef4444;display:none"></div>
  <div id="result" style="display:none">
    <h2>Résultat</h2><div id="meta" class="muted"></div>
    <h3>Constats</h3><ul id="findings"></ul>
    <h3>Aperçu (10 premières lignes)</h3><div id="preview"></div>
    <div class="row"><button id="btn-retry">Ré-analyser</button><a href="/">← Retour</a><a href="/docs" target="_blank">Docs API →</a></div>
  </div>
</div></div>
<script>
  const qs = new URLSearchParams(location.search); const url = qs.get("u");
  document.getElementById("src").textContent = url ? `Source : ${url}` : "Aucune URL fournie.";
  async function run() {
    const status=document.getElementById("status"), error=document.getElementById("error"), result=document.getElementById("result");
    error.style.display="none"; result.style.display="none"; status.style.display="block";
    if (!url) { error.textContent="Aucune URL reçue."; error.style.display="block"; status.style.display="none"; return; }
    try {
      const r = await fetch("/plannings/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url})});
      const j = await r.json();
      if(!r.ok || !j.ok){ error.textContent=j?.message||"Analyse impossible."; error.style.display="block"; status.style.display="none"; return; }
      status.style.display="none"; result.style.display="block";
      const meta=document.getElementById("meta"), findings=document.getElementById("findings"), preview=document.getElementById("preview");
      meta.textContent = `Lignes : ${j.data?.meta?.rows ?? "?"}`;
      findings.innerHTML = (j.data?.findings||[]).map(f=>`<li>${f.type?`[${f.type}] `:""}${f.message||JSON.stringify(f)}</li>`).join("") || "<li>Aucun constat.</li>";
      const rows = j.data?.preview || [];
      if (rows.length===0) { preview.innerHTML = "<p class='muted'>Aucun aperçu disponible.</p>"; }
      else {
        const cols = Object.keys(rows[0]);
        preview.innerHTML = "<table><thead><tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr></thead><tbody>" +
          rows.map(r=>"<tr>"+cols.map(c=>`<td>${r[c]??""}</td>`).join("")+"</tr>").join("") + "</tbody></table>";
      }
    } catch(e){ error.textContent = e.message || "Erreur réseau."; error.style.display="block"; status.style.display="none"; }
  }
  document.getElementById("btn-retry").addEventListener("click", run); run();
</script>
