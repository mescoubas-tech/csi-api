{% extends "base.html" %}
{% block title %}CSI — Analyse planning{% endblock %}
{% block content %}
  <h1>Analyse des plannings</h1>
  <div class="card">
    <label for="planning-url">URL du planning</label>
    <input id="planning-url" type="url" placeholder="https://exemple.tld/planning" />
    <div class="row">
      <button id="btn-analyze">Analyser</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div id="error" class="error" style="display:none"></div>
  <div id="result" style="display:none" class="card">
    <h3>Résultat</h3>
    <div id="meta" class="muted"></div>
    <h4>Constats</h4>
    <ul id="findings"></ul>
    <h4>Aperçu (10 premières lignes)</h4>
    <div id="preview"></div>
  </div>

  <script>
    const urlInput = document.getElementById('planning-url');
    const btn = document.getElementById('btn-analyze');
    const st = document.getElementById('status');
    const err = document.getElementById('error');
    const res = document.getElementById('result');

    btn.addEventListener('click', async ()=>{
      const u = urlInput.value.trim();
      err.style.display='none'; res.style.display='none'; st.textContent='Analyse en cours…';
      if(!u){ err.textContent='Merci de saisir une URL.'; err.style.display='block'; st.textContent=''; return; }
      try{
        const r = await fetch('/plannings/analyze', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({url:u})});
        const j = await r.json();
        if(!r.ok || !j.ok){ throw new Error(j?.message || 'Analyse impossible.'); }
        st.textContent=''; res.style.display='block';
        document.getElementById('meta').textContent = 'Lignes : ' + (j.data?.meta?.rows ?? '?');
        const findings = document.getElementById('findings');
        findings.innerHTML = (j.data?.findings||[]).map(f=>`<li>${f.type?`[${f.type}] `:''}${f.message||JSON.stringify(f)}</li>`).join('') || '<li>Aucun constat.</li>';
        const rows = j.data?.preview || [];
        const preview = document.getElementById('preview');
        if(rows.length===0){ preview.innerHTML = "<p class='muted'>Aucun aperçu disponible.</p>"; }
        else{
          const cols = Object.keys(rows[0]);
          preview.innerHTML = "<table><thead><tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr></thead><tbody>"+
            rows.map(r=>"<tr>"+cols.map(c=>`<td>${r[c]??''}</td>`).join("")+"</tr>").join("")+
            "</tbody></table>";
        }
      }catch(e){
        st.textContent=''; err.textContent = e.message || e; err.style.display='block';
      }
    });
  </script>
{% endblock %}
